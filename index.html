<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">

    <script src="neataptic.js"></script>
    <script src="common.js"></script>
    <script src="data.js"></script>
  </head>
  <body>
    <form onsubmit="testForm();return false;">
      <input type="number" step="any" placeholder="Ambient" required id="ambient" value="">
      <input type="number" step="any" placeholder="Superheat" required id="sh" value="">
      <input type="number" step="any" placeholder="Subcool" required id="sc" value="">
      <input type="number" step="any" placeholder="Low side temp" required id="lt" value="">
      <input type="number" step="any" placeholder="High side temp" required id="ht" value="">
      <br/>
      <input type="number" step="any" placeholder="Design amp" id="da" value="">
      <input type="number" step="any" placeholder="Actual amp" id="aa" value="">
      <button type="reset">Reset</button>
      <button type="submit">Submit</button>
    </form>

    <div id="results"></div>

    <br><br><br><br><br><br><br><br><br>
    <div id="console"></div>
    
    <script src="index.js"></script>

    <script type="text/javascript">
      function testForm() {
        let da = parseFloat(document.getElementById('da').value);
        let aa = parseFloat(document.getElementById('aa').value);

        let amp;

        let predictamp = activate(parseFloat(document.getElementById('ambient').value),
                        parseFloat(document.getElementById('sh').value),
                        parseFloat(document.getElementById('sc').value),
                        parseFloat(document.getElementById('lt').value),
                        parseFloat(document.getElementById('ht').value), networkToPredictAmp)[0];

        if (!da || !aa) {
          amp = predictamp;
        } else
          amp = aa / da;


        let results = activate(parseFloat(document.getElementById('ambient').value),
                        parseFloat(document.getElementById('sh').value),
                        parseFloat(document.getElementById('sc').value),
                        parseFloat(document.getElementById('lt').value),
                        parseFloat(document.getElementById('ht').value),
                        amp);
                        
        // Charge prediction ===
        
        let chargePredictionHTML = '';
        if (results[0] >= 20) {
          let predictCharge = activateChargeNetwork(parseFloat(document.getElementById('ambient').value),
                        parseFloat(document.getElementById('sh').value),
                        parseFloat(document.getElementById('sc').value),
                        parseFloat(document.getElementById('lt').value),
                        parseFloat(document.getElementById('ht').value),
                        amp);
          chargePredictionHTML = `, add ~ ${predictCharge}% charge <form onsubmit="this.innerHTML = Math.round(this.children[0].value * ${predictCharge} / 10) / 10 + 'lbs';return false;"><input type="number" step="0.1"><button type="submit" style="display: none;"></button></form>`;
        }
        
        let problem = 'font-weight: bold; color: red;';
        let warning = 'font-weight: normal; color: orange; opacity: 0.8';
        let good = 'font-weight: 200; color: green; opacity: 0.6';
        let html = `
        <span style="${(!da || !aa) && predictamp > 0.9 ? problem : (!da || !aa) && predictamp > 0.7 ? warning : (!da || !aa) ? good : ''}">Predicted Amp ratio: ${Math.round(predictamp * 100) / 100}</span><br />
        <span style="${(da && aa) && amp > 0.9 ? problem : (da && aa) && amp > 0.7 ? warning : (da && aa) ? good : ''}">${!da || !aa ? '' : 'Actual ratio: ' + Math.round(amp * 100) / 100}<br /></span><br />
        `;
        let problems = [];
        problems.push([results[0], `<span style="${results[0] >= 60 ? problem : results[0] >= 20 ? warning : good};}">Undercharge: ${results[0]}%${chargePredictionHTML}</span><br />`]);
        problems.push([results[1], `<span style="${results[1] >= 60 ? problem : results[1] >= 20 ? warning : good};}">Overcharge: ${results[1]}%</span><br />`]);
        problems.push([results[2], `<span style="${results[2] >= 60 ? problem : results[2] >= 20 ? warning : good};}">Low Indoor Flow: ${results[2]}%</span><br />`]);
        problems.push([results[3], `<span style="${results[3] >= 60 ? problem : results[3] >= 20 ? warning : good};}">Dirty coil: ${results[3]}%</span><br />`]);
        problems.push([results[4], `<span style="${results[4] >= 60 ? problem : results[4] >= 20 ? warning : good};}">Restriction: ${results[4]}%</span><br />`]);
        problems.push([results[5], `<span style="${results[5] >= 60 ? problem : results[5] >= 20 ? warning : good};}">TXV Stuck Open: ${results[5]}%</span><br />`]);

        problems.sort((a, b) => (b[0] - a[0])).forEach(x => {
          html += x[1];
        });

        document.getElementById('results').innerHTML = html;
      }
    </script>
  </body>
</html>
